> [!CAUTION]
> 本文档使用 GPT AI 辅助编写，GPT 模型：o1-preview

# 2RPM - 使用说明

介绍如何使用 2RPM，包括安装、配置、运行和打包等步骤。

适用于：[2RPM-v1](.\2RPM-v1.py)

---

## 目录

1. [脚本用途](#1-脚本用途)
2. [安装 Python](#2-下载并安装-python)
3. [安装依赖库](#3-安装依赖库)
4. [配置脚本](#4-配置脚本)
5. [获取 ServerChan 密钥](#5-获取-serverchan-密钥)
6. [测试运行脚本](#6-测试运行脚本)
7. [打包 exe 文件](#7-打包-exe-文件)
   - [打包为有控制台输出的 exe 文件](#72-打包为有控制台输出的-exe-文件)
   - [打包为无控制台输出的 exe 文件](#73-打包为无控制台输出的-exe-文件)
8. [(不推荐)通过批处理文件运行脚本](#8-通过批处理文件运行脚本不推荐)
9. [常见问题](#常见问题)
10. [附录：参数详细](#附录参数详细)

---

## 1. 脚本用途

2RPM 脚本用于监视指定的进程，当以下情况发生时发送通知：

- **进程未运行**：在指定的等待时间内未检测到目标进程启动。
- **进程运行时间过长**：进程的运行时间超过了设定的警告间隔。
- **进程结束**：监视的进程意外终止或正常结束。

通过 ServerChan 将通知发送到微信或平台，方便及时了解进程状态。

---

## 2. 下载并安装 Python

1. **下载 Python 安装包**

   - 访问 [Python 官方网站](https://www.python.org/downloads/)。
   - 下载适用于您操作系统的最新版本 Python 3 安装包。

2. **安装 Python**

   - 运行下载的安装包。
   - 在安装过程中，**勾选** “Add Python 3.x to PATH” （将 Python 添加到环境变量）。
   - 选择 “Install Now” 进行默认安装。

3. **验证安装**

   安装完成后，再次在命令行中输入：

   ```bash
   python --version
   ```

   若能看到 Python 的版本信息，则表示安装成功。

---

## 3. 安装依赖库

该脚本依赖于 `psutil` 库，请按照以下步骤安装依赖库：

1. **打开命令行或终端**

   - 按 `Win + R`，输入 `cmd`，然后按回车。

2. **安装 `psutil` 库**

   输入以下命令安装 `psutil`：

   ```bash
   pip install psutil
   ```

   如果提示 `pip` 未安装，可以尝试使用 `python -m pip install psutil`。

3. **验证安装**

   安装完成后，输入以下命令检查是否安装成功：

   ```bash
   pip show psutil
   ```

   如果显示了 `psutil` 的版本信息，表示安装成功。

---

## 4. 配置脚本

在使用脚本之前，需要根据您的需求进行配置。打开脚本文件 `2RPM.py`，找到 **配置部分**，根据以下说明进行修改。

### 4.1 需要监视的进程

找到以下代码行，替换为您要监视的进程名称列表：

```python
PROCESS_NAMES = ['notepad.exe', 'chrome.exe']  # 替换为实际进程名
```

例如，要监视 `your_process.exe`，修改为：

```python
PROCESS_NAMES = ['your_process.exe']
```

### 4.2 通知密钥

找到以下代码行，替换为您在 Server 酱获取的实际密钥：

```python
NOTIFICATION_KEY = 'ServerChan_key'  # 替换为您的实际密钥
```

### 4.3 配置其他参数

#### 4.3.1 日志配置

- **是否输出日志文件**

  如果您不希望将日志输出到文件，可以将 `LOG_TO_FILE` 设置为 `False`：

  ```python
  LOG_TO_FILE = True  # 设置为 False 禁用日志文件输出
  ```

- **日志输出目录**

  默认情况下，日志文件保存在脚本所在目录下的 `logs` 文件夹中。您可以修改 `LOG_DIR` 变量来自定义日志输出目录：

  ```python
  LOG_DIR = 'logs'  # 自定义日志输出目录:'C:\\path\\to\\logs'
  ```

#### 4.3.2 超时警告

- **超时警告间隔**

  修改以下参数来设置进程运行时间的警告间隔（单位为秒）：

  ```python
  ALERT_INTERVAL_SECONDS = 900  # 默认15分钟
  ```

  例如，将其修改为 5 分钟：

  ```python
  ALERT_INTERVAL_SECONDS = 300  # 5分钟
  ```

#### 4.3.3 等待时间

- **等待进程启动的最长时间**

  修改以下参数来设置在未检测到进程时，等待进程启动的最长时间（单位为秒）：

  ```python
  PROCESS_START_WAIT_TIME = 30  # 默认30秒
  ```

- **等待进程启动时的检查间隔**

  在等待目标进程启动时，程序每隔指定的毫秒数检查一次是否有目标进程启动。

  ```python
  PROCESS_CHECK_INTERVAL = 1000  # 默认1秒
  ```

- **监视循环的睡眠间隔**

  修改以下参数来指定主监视循环中，每次检查之间的等待时间。值越小，检查频率越高，但可能会增加系统资源消耗。（以毫秒为单位）

  ```python
  SLEEP_INTERVAL = 3000  # 默认3秒
  ```

#### 4.3.4 推送错误重试

- **推送错误重试间隔**

  修改以下参数来设置推送错误重试的间隔时间（单位为秒）：

  ```python
  RETRY_INTERVAL_SECONDS = 1  # 默认1秒
  ```

- **最大重试次数**

  修改以下参数来设置推送错误重试的最大重试次数：

  ```python
  MAX_RETRIES = 3  # 默认3次
  ```

---

## 5. 获取 ServerChan 密钥

Server 酱（ServerChan）是一个可以将服务器、设备、应用程序等的消息推送到微信的工具。要使用 Server 酱发送通知，需要获取一个密钥。

### 5.1 注册并登录

1. **访问官网**

   打开浏览器，访问 [Server 酱官网](https://sct.ftqq.com/)。

### 5.2 获取 SendKey

1. **创建消息通道**

   登录后，在 “我的消息通道” 页面，点击 “创建消息通道”。

2. **获取 SendKey**

   创建后，您将看到一个类似 `SCTxxxxxxxxxxxxxxxxxxxx` 的 SendKey，这就是您的通知密钥。

3. **配置消息通道**

   您可以根据需要在 “消息通道配置” 中设置接收通知的方式，例如微信、邮件等。

### 5.3 将密钥添加到脚本

在脚本的配置部分，将 `NOTIFICATION_KEY` 设置为您的 SendKey：

```python
NOTIFICATION_KEY = 'SCTxxxxxxxxxxxxxxxxxxxx'  # 替换为您的实际密钥
```

---

## 6. 测试运行脚本

在终端中，运行以下命令：

```bash
python C:\path\2RPM.py
```

---

## 7. 打包 exe 文件

建议使用 PyInstaller 将 2RPM 打包为可执行的 exe 文件，方便直接调用运行。

### 7.1 安装 PyInstaller

在命令行或终端中运行以下命令安装 PyInstaller：

```bash
pip install pyinstaller
```

### 7.2 打包为有控制台输出的 exe 文件

如果您希望在运行 exe 文件时看到控制台输出，请按照以下步骤：

1. **导航到脚本目录**

   ```bash
   cd path\to\your\script
   ```

2. **运行 PyInstaller 命令**

   ```Python
   pyinstaller -F -c 2RPM.py -n 2RPM使用控制台
   ```

3. **找到生成的 exe 文件**

   打包完成后，生成的 exe 文件位于 `dist` 目录下，名为 `2RPM.exe`。

### 7.3 打包为无控制台输出的 exe 文件

如果您希望脚本在后台运行，不显示控制台窗口，请使用以下命令：

```Python
pyinstaller -F -w 2RPM.py -n 2RPM不显示命令行窗口
```

这样生成的 exe 文件在运行时不会弹出控制台窗口。

### 7.4 注意事项

- **确保所有依赖库都已安装**

  在打包前，确保您已安装了所有必要的依赖库，例如 `psutil`。

- **更新脚本路径**

  如果脚本中有涉及到相对路径的配置，请确保在打包后路径依然正确。

- **测试 exe 文件**

  打包完成后，建议在目标环境中测试 exe 文件，确保其能够正常运行。

---

## 8. 通过批处理文件运行脚本(不推荐)

不建议通过批处理文件运行脚本，若多 Python 版本共存或更新 Python 版本，或者其他不可预知的问题（例如：Python 无法识别依赖库）会导致无法运行脚本。

```bat
@echo off
start "C:\Windows\System32\cmd.exe"
python x:\2RPM.py
taskkill /f /im cmd.exe
exit
```

若有空格请使用该方案：

```bat
@echo off
set "RPM=C:\T O\2RPM使用控制台.exe"
start "C:\Windows\System32\cmd.exe"
python "%RPM%"
taskkill /f /im cmd.exe
exit
```

---

## 常见问题

### 1. 运行脚本时提示缺少模块

**解决方法**：确保已按照 [安装依赖库](#3-安装依赖库) 章节安装了所有依赖库。如果依然有问题，尝试重新安装：

```bash
pip install --force-reinstall --no-cache-dir psutil
```

### 2. 打包后的 exe 文件无法运行

**解决方法**：

- 确保在打包前已安装所有依赖库。
- 检查脚本中是否有硬编码的文件路径，调整为相对路径或在脚本中处理路径问题。
- 询问 GPT AI ，使用 o1-preview 模型

### 3. 收不到 Server 酱的通知

**解决方法**：

- 确保在脚本中正确设置了 `NOTIFICATION_KEY`。
- 登录 Server 酱官网，检查消息通道配置是否正确。
- 检查网络连接，确保能够访问网络。

---

## 附录：参数详细

### 附录 1.日志输出设置

- **`LOG_TO_FILE`**：是否将日志输出到文件。

  - **类型**：布尔值（`True` 或 `False`）
  - **默认值**：`True`
  - **作用**：决定程序运行时的日志信息是否需要保存到文件中。设置为 `True` 时，日志会被写入指定的日志文件；设置为 `False` 时，日志只会在控制台输出，不会生成日志文件。

- **`LOG_DIR`**：日志文件的保存目录。

  - **类型**：字符串
  - **默认值**：`'logs'`
  - **作用**：指定日志文件保存的路径。可以是绝对路径或相对路径。如果是相对路径，则相对于脚本所在的目录。

- **`LOG_RETENTION_DAYS`**：日志保留的天数。

  - **类型**：整数
  - **默认值**：`3`
  - **作用**：指定日志文件的保留期限。程序会自动删除超过指定天数的旧日志文件，以节省存储空间。

- **`MAX_LOG_FILES`**：最大日志文件数量。
  - **类型**：整数
  - **默认值**：`15`
  - **作用**：限制日志文件的最大数量。当日志文件数量超过该值时，程序会自动删除最旧的日志文件，确保日志文件的数量不超过该限制。

---

### 附录 2.日志配置

- **`logger`**：日志记录器配置。

  - **作用**：配置日志的输出格式、级别、处理器等。包括控制台和文件的日志格式和级别。

- **`formatter_file`** 和 **`formatter_console`**：日志格式化器。

  - **作用**：定义日志信息的格式。在日志文件和控制台输出中使用不同的格式，便于阅读。

- **`handler_console`** 和 **`handler_file`**：日志处理器。
  - **作用**：将日志信息输出到控制台和文件中。根据 `LOG_TO_FILE` 参数，决定是否启用文件日志处理器。

---

### 附录 3.监视和通知设置

- **`ALERT_INTERVAL_SECONDS`**：超时警告间隔（以秒为单位）。

  - **类型**：整数
  - **默认值**：`900`（即 15 分钟）
  - **作用**：指定在监视进程时，进程运行时间超过多少秒后，发送警告通知。该值应为 60 的倍数，因为警告通知中会以分钟为单位提示。

- **`SLEEP_INTERVAL`**：监视循环的睡眠间隔（以毫秒为单位）。

  - **类型**：整数
  - **默认值**：`3000`（即 3 秒）
  - **作用**：指定主监视循环中，每次检查之间的等待时间。值越小，检查频率越高，但可能会增加系统资源消耗。

- **`PROCESS_START_WAIT_TIME`**：等待进程启动的最长时间（以秒为单位）。

  - **类型**：整数
  - **默认值**：`30`
  - **作用**：当程序启动时，如果未找到目标进程，程序会等待一段时间以等待进程启动。该参数指定了最大等待时间。如果超过该时间仍未找到目标进程，程序将发送通知并退出。

- **`PROCESS_CHECK_INTERVAL`**：等待进程启动时的检查间隔（以毫秒为单位）。
  - **类型**：整数
  - **默认值**：`1000`（即 1 秒）
  - **作用**：在等待目标进程启动时，程序每隔指定的毫秒数检查一次是否有新的目标进程启动。

---

### 附录 4.通知和重试设置

- **`NOTIFICATION_KEY`**：通知密钥。

  - **类型**：字符串
  - **默认值**：`'ServerChan_key'`
  - **作用**：用于 Server 酱的通知密钥。需要替换为您自己的密钥，以便程序能够通过 Server 酱发送通知。

- **`PROCESS_NAMES`**：要监视的进程名称列表。

  - **类型**：列表（字符串）
  - **默认值**：`['process.exe']`
  - **作用**：指定需要监视的进程名称。可以包含一个或多个进程名，例如：`['notepad.exe', 'chrome.exe']`。

- **`RETRY_INTERVAL_SECONDS`**：推送错误重试的间隔时间（以秒为单位）。

  - **类型**：整数
  - **默认值**：`1`
  - **作用**：当通知发送失败时，程序会按照指定的秒数等待后重试发送。

- **`MAX_RETRIES`**：最大重试次数。
  - **类型**：整数
  - **默认值**：`3`
  - **作用**：指定在通知发送失败时，程序最多会尝试重试发送的次数。如果超过该次数，程序将记录错误并退出。

---

### 附录 5.通知模板设置

- **`NOTIFICATION_TEMPLATES`**：通知的模板配置。

  - **类型**：字典
  - **作用**：定义了三种不同场景下的通知标题和内容模板，包括：

    - `send_no_process_found`：未找到目标进程时的通知模板。
    - `send_process_end`：监视的进程结束时的通知模板。
    - `send_alert`：监视的进程运行时间超过预期时的通知模板。

  - **可用参数**：
    - `{hostname}`：主机名。
    - `{current_time}`：当前时间，格式为`YYYY/MM/DD HH:MM:SS`。
    - `{short_current_time}`：当前时间的短格式，格式为`HH:MM:SS`。
    - `{process_name}`：进程名称。
    - `{process_pid}`：进程的 PID。
    - `{run_time}`：进程已运行的时间，格式为`HH:MM:SS`。
    - `{total_minutes}`：进程已运行的总分钟数。
    - `{process_list}`：未运行的进程列表。
    - `{other_processes}`：其他被监视的进程状态。
    - `{wait_time}`：等待的时间，格式为`HH:MM:SS`。
